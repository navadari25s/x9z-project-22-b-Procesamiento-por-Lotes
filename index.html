<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armonía Negativa Pro - Batch Engine</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #0f172a, #1e1b4b, #312e81);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 1rem;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.7);
        }
        .btn-magic {
            background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            background-size: 200% 200%;
            animation: gradient-anim 3s ease infinite;
            transition: all 0.3s ease;
        }
        @keyframes gradient-anim {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #ffffff; cursor: pointer; margin-top: -5px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255, 255, 255, 0.2); border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="glass-panel w-full max-w-2xl rounded-3xl p-6 md:p-8 relative overflow-hidden transition-all duration-500">
        <div class="absolute -top-32 -right-32 w-64 h-64 bg-indigo-500/10 rounded-full blur-[80px]"></div>
        <div class="absolute -bottom-32 -left-32 w-64 h-64 bg-fuchsia-500/10 rounded-full blur-[80px]"></div>

        <div class="text-center mb-6 relative z-10">
            <h1 class="text-4xl md:text-5xl font-black mb-1 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 tracking-tighter">
                Armonía Negativa <span class="text-sm align-top bg-indigo-500 text-white px-2 py-0.5 rounded-full ml-1">PRO</span>
            </h1>
            <p class="text-indigo-200/50 text-[10px] font-bold uppercase tracking-[0.3em]">Procesamiento de Lotes Sin Mezclas</p>
        </div>

        <div id="status-area" class="mb-4 text-center h-5 text-xs font-medium text-indigo-300 transition-all duration-300"></div>

        <!-- PASO 0: INICIALIZACIÓN -->
        <div id="step-0" class="relative z-10">
            <div class="p-8 bg-slate-900/50 rounded-2xl border border-white/10 text-center">
                <i class="fas fa-shield-virus text-4xl text-indigo-400 mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2">Motor de Aislamiento MIDI</h3>
                <p class="text-sm text-slate-400 mb-6">Cargando bancos de sonidos completos para máxima fidelidad.</p>
                <button id="init-btn" class="btn-magic w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg flex items-center justify-center gap-3">
                    <span id="init-text">ACTIVAR MOTOR</span>
                    <i id="init-icon" class="fas fa-bolt"></i>
                </button>
                <div id="loader-bar-container" class="w-full bg-slate-700 h-2 rounded-full mt-6 hidden overflow-hidden">
                    <div id="loader-bar" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <!-- PASO 1: SUBIDA MÚLTIPLE -->
        <div id="step-1" class="hidden relative z-10">
            <input type="file" id="midi-input" accept=".mid,.midi" multiple class="hidden">
            <label for="midi-input" class="cursor-pointer flex flex-col items-center justify-center border-2 border-dashed border-slate-600/50 rounded-2xl p-10 group transition-all hover:border-indigo-500/50 bg-slate-900/20">
                <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 group-hover:bg-indigo-500/20 transition-all duration-300">
                    <i class="fas fa-layer-group text-2xl text-indigo-400 group-hover:scale-110 transition-transform"></i>
                </div>
                <span class="text-lg font-bold text-slate-200">Subir Lote de Archivos</span>
                <span class="text-xs text-slate-500 mt-2">Cada archivo se procesará en una memoria aislada</span>
            </label>
        </div>

        <!-- PASO 2: COLA -->
        <div id="step-2" class="hidden relative z-10 flex flex-col h-[450px]">
            <div class="flex justify-between items-end mb-4">
                <h3 class="text-sm font-bold text-indigo-300 uppercase tracking-widest">Cola de Trabajo</h3>
                <span id="queue-count" class="text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded">0 Archivos</span>
            </div>
            
            <div id="file-queue" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2 mb-4"></div>

            <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                <button id="process-all-btn" class="btn-magic py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 order-1">
                    <i class="fas fa-microchip"></i> PROCESAR LOTE
                </button>
                <button id="download-zip-btn" class="hidden bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 transition-colors shadow-lg order-2">
                    <i class="fas fa-file-archive"></i> DESCARGAR ZIP FINAL
                </button>
                <button id="clear-queue-btn" class="bg-slate-800 hover:bg-slate-700 py-4 rounded-xl text-slate-300 font-bold flex items-center justify-center gap-2 transition-colors order-3 sm:col-span-2">
                    <i class="fas fa-trash-alt"></i> REINICIAR TODO
                </button>
            </div>
        </div>

        <!-- REPRODUCTOR -->
        <div id="player-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl border border-white/20">
                <div class="flex justify-between items-start mb-6">
                    <div class="overflow-hidden">
                        <h4 class="text-xs font-bold text-indigo-400 uppercase">Previsualización Segura</h4>
                        <p id="preview-name" class="text-sm font-medium text-white truncate"></p>
                    </div>
                    <button id="close-player" class="text-slate-500 hover:text-white p-2"><i class="fas fa-times"></i></button>
                </div>

                <div class="space-y-4">
                    <button id="play-btn" class="w-full bg-indigo-600 text-white py-4 rounded-xl flex items-center justify-center gap-3 font-bold hover:bg-indigo-500 transition-colors">
                        <i id="play-icon" class="fas fa-play"></i> <span id="play-text">REPRODUCIR</span>
                    </button>
                    
                    <div class="px-1">
                        <div class="flex justify-between text-[10px] text-indigo-300/70 mb-1 font-mono">
                            <span id="current-time">0:00</span>
                            <span id="total-time">0:00</span>
                        </div>
                        <input type="range" id="seek-slider" min="0" max="100" value="0" step="0.1">
                    </div>

                    <div class="flex items-center gap-3 bg-black/20 rounded-lg p-2 border border-white/5">
                        <i class="fas fa-volume-up text-indigo-400 text-xs"></i>
                        <input type="range" id="volume-slider" min="-30" max="0" value="-5" step="1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicialización del reproductor con el banco de alta fidelidad SGM Plus
        const player = new mm.SoundFontPlayer('https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus');
        
        const state = {
            files: [], 
            currentIndex: null,
            playbackInterval: null,
            startTime: 0,
            pauseOffset: 0,
            isSeeking: false
        };

        const step0 = document.getElementById('step-0');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const initBtn = document.getElementById('init-btn');
        const loaderBar = document.getElementById('loader-bar');
        const statusArea = document.getElementById('status-area');
        const fileInput = document.getElementById('midi-input');
        const fileQueue = document.getElementById('file-queue');
        const queueCount = document.getElementById('queue-count');
        const playerModal = document.getElementById('player-modal');
        const zipBtn = document.getElementById('download-zip-btn');
        
        // --- MOTOR ---
        initBtn.onclick = async () => {
            initBtn.disabled = true;
            document.getElementById('init-text').textContent = "CARGANDO SONIDOS...";
            document.getElementById('loader-bar-container').classList.remove('hidden');
            
            try {
                if (mm.Player.tone && mm.Player.tone.context.state !== 'running') await mm.Player.tone.context.resume();
                
                // Precarga de instrumentos principales de SGM Plus para evitar delays luego
                const initSequence = { 
                    notes: [
                        {pitch: 60, startTime: 0, endTime: 0.1, program: 0}, // Piano
                        {pitch: 62, startTime: 0, endTime: 0.1, program: 24}, // Guitarra
                        {pitch: 64, startTime: 0, endTime: 0.1, program: 32}, // Bajo
                        {pitch: 60, startTime: 0, endTime: 0.1, isDrum: true}  // Batería
                    ], 
                    totalTime: 0.2 
                };
                
                loaderBar.style.width = "40%";
                await player.loadSamples(initSequence);
                loaderBar.style.width = "100%";

                setTimeout(() => {
                    step0.classList.add('hidden');
                    step1.classList.remove('hidden');
                    showStatus("✅ Motor de alta fidelidad activo", "text-emerald-400");
                }, 400);
            } catch (e) {
                console.error(e);
                showStatus("❌ Error al cargar sonidos", "text-rose-400");
                initBtn.disabled = false;
                document.getElementById('init-text').textContent = "REINTENTAR";
            }
        };

        // --- CARGA ---
        fileInput.onchange = async (e) => {
            const uploaded = Array.from(e.target.files).slice(0, 50);
            if (uploaded.length === 0) return;

            for (const file of uploaded) {
                const buffer = await file.arrayBuffer();
                state.files.push({
                    id: Math.random().toString(36).substring(2, 10),
                    name: file.name,
                    originalBuffer: new Uint8Array(buffer).slice(0).buffer,
                    transformedBinary: null,
                    noteSequence: null,
                    status: 'pending'
                });
            }

            renderQueue();
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            zipBtn.classList.add('hidden');
            fileInput.value = "";
        };

        function renderQueue() {
            fileQueue.innerHTML = '';
            queueCount.textContent = `${state.files.length} Archivos`;

            state.files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = "bg-white/5 border border-white/5 rounded-xl p-3 flex items-center justify-between gap-3";
                
                const icon = file.status === 'done' ? 'fa-check-circle text-emerald-400' : 
                             file.status === 'error' ? 'fa-exclamation-circle text-rose-400' :
                             'fa-clock text-slate-500';

                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                        <i class="fas ${icon} text-xs"></i>
                        <span class="text-xs font-medium truncate text-slate-300">${file.name}</span>
                    </div>
                    <div class="flex gap-2">
                        ${file.status === 'done' ? `
                            <button onclick="previewFile(${index})" class="w-8 h-8 rounded-lg bg-indigo-500/20 text-indigo-400 flex items-center justify-center hover:bg-indigo-500 hover:text-white transition-all">
                                <i class="fas fa-play text-[10px]"></i>
                            </button>
                        ` : ''}
                        <button onclick="removeFile(${index})" class="w-8 h-8 rounded-lg bg-rose-500/10 text-rose-400/50 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                `;
                fileQueue.appendChild(item);
            });
        }

        // --- TRANSFORMACIÓN ---
        document.getElementById('process-all-btn').onclick = async () => {
            const btn = document.getElementById('process-all-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> PROCESANDO...';
            
            let count = 0;
            for (let i = 0; i < state.files.length; i++) {
                if (state.files[i].status === 'done') { count++; continue; }
                try {
                    showStatus(`Transformando armonía: ${state.files[i].name}`, "text-indigo-300");
                    await processIsolatedFile(i);
                    state.files[i].status = 'done';
                    count++;
                } catch (e) {
                    state.files[i].status = 'error';
                }
                renderQueue();
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microchip"></i> PROCESAR LOTE';
            if (count > 0) zipBtn.classList.remove('hidden');
            showStatus(count > 0 ? `✨ Lote completado` : "", "text-emerald-400");
        };

        async function processIsolatedFile(index) {
            const file = state.files[index];
            const localMidi = new Midi(file.originalBuffer.slice(0)); 
            const mapping = [];

            localMidi.tracks.forEach((track, tid) => {
                const isPerc = track.channel === 9 || track.instrument.percussion;
                mapping[tid] = { prog: track.instrument.number, isPerc };
                if (!isPerc) {
                    track.notes.forEach(note => {
                        let inv = 127 - note.midi;
                        while (inv > note.midi + 7) inv -= 12;
                        while (inv < note.midi - 7) inv += 12;
                        note.midi = Math.max(0, Math.min(127, inv));
                    });
                }
            });

            file.transformedBinary = new Uint8Array(localMidi.toArray()).slice(0);
            const blob = new Blob([file.transformedBinary], { type: 'audio/midi' });
            let ns = await mm.blobToNoteSequence(blob);
            
            // CORRECCIÓN DE LATENCIA: Eliminar silencios iniciales de la secuencia
            if (ns.notes.length > 0) {
                const firstNoteTime = Math.min(...ns.notes.map(n => n.startTime));
                if (firstNoteTime > 0) {
                    ns.notes.forEach(n => {
                        n.startTime -= firstNoteTime;
                        n.endTime -= firstNoteTime;
                    });
                    ns.totalTime -= firstNoteTime;
                }
            }

            ns.notes.forEach(n => {
                const m = mapping[n.instrument];
                if (m) {
                    n.isDrum = m.isPerc;
                    if (!m.isPerc) n.program = m.prog;
                }
            });
            
            file.noteSequence = ns;
            // Aseguramos carga de patches específicos
            await player.loadSamples(ns);
        }

        // --- ZIP ---
        zipBtn.onclick = async () => {
            const zip = new JSZip();
            const folder = zip.folder("Midis_Negativos");
            let idx = 1;
            state.files.forEach(f => {
                if (f.status === 'done' && f.transformedBinary) {
                    const uniqueFileName = `${idx}_${f.name.replace(/\.[^/.]+$/, "")}_NEGATIVO.mid`;
                    folder.file(uniqueFileName, f.transformedBinary.slice(0));
                    idx++;
                }
            });
            const blobZip = await zip.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(blobZip);
            const link = document.createElement("a");
            link.href = url;
            link.download = `Pack_Armonia_Negativa_${Date.now()}.zip`;
            link.click();
        };

        // --- REPRODUCTOR CON SEEK ---
        window.previewFile = (index) => {
            stopPlayback();
            state.currentIndex = index;
            state.pauseOffset = 0;
            const file = state.files[index];
            document.getElementById('preview-name').textContent = file.name;
            document.getElementById('total-time').textContent = formatTime(file.noteSequence.totalTime);
            document.getElementById('seek-slider').max = file.noteSequence.totalTime;
            document.getElementById('seek-slider').value = 0;
            document.getElementById('current-time').textContent = "0:00";
            playerModal.classList.remove('hidden');
        };

        document.getElementById('play-btn').onclick = () => {
            if (player.isPlaying()) {
                state.pauseOffset = parseFloat(document.getElementById('seek-slider').value);
                stopPlayback();
            } else {
                startPlayback(state.pauseOffset);
            }
        };

        // Lógica de adelantar con el puntero
        const seekSlider = document.getElementById('seek-slider');
        seekSlider.onmousedown = () => state.isSeeking = true;
        seekSlider.onmouseup = () => {
            state.isSeeking = false;
            const wasPlaying = player.isPlaying();
            const newPos = parseFloat(seekSlider.value);
            state.pauseOffset = newPos;
            
            if (wasPlaying) {
                stopPlayback();
                startPlayback(newPos);
            } else {
                document.getElementById('current-time').textContent = formatTime(newPos);
            }
        };

        seekSlider.ontouchstart = () => state.isSeeking = true;
        seekSlider.ontouchend = () => {
            state.isSeeking = false;
            const newPos = parseFloat(seekSlider.value);
            state.pauseOffset = newPos;
            if (player.isPlaying()) { stopPlayback(); startPlayback(newPos); }
        };

        async function startPlayback(startTimeSeconds = 0) {
            const file = state.files[state.currentIndex];
            const playIcon = document.getElementById('play-icon');
            const playText = document.getElementById('play-text');
            
            playIcon.className = "fas fa-stop";
            playText.textContent = "DETENER";
            
            let seqToPlay = file.noteSequence;
            // Trim de la secuencia para empezar desde el punto elegido (Seek)
            if (startTimeSeconds > 0.01) {
                try {
                    seqToPlay = mm.sequences.trim(file.noteSequence, startTimeSeconds, file.noteSequence.totalTime);
                } catch(e) { console.warn("Error al recortar secuencia:", e); }
            }

            player.start(seqToPlay).then(() => {
                if (player.isPlaying() && !state.isSeeking) stopPlayback();
            });

            state.startTime = Date.now();
            state.playbackInterval = setInterval(() => {
                if (state.isSeeking) return;
                
                const elapsedSinceStart = (Date.now() - state.startTime) / 1000;
                const currentTotalPos = startTimeSeconds + elapsedSinceStart;

                if (currentTotalPos < file.noteSequence.totalTime) {
                    seekSlider.value = currentTotalPos;
                    document.getElementById('current-time').textContent = formatTime(currentTotalPos);
                } else {
                    stopPlayback();
                }
            }, 50);
        }

        function stopPlayback() {
            player.stop();
            if(state.playbackInterval) clearInterval(state.playbackInterval);
            document.getElementById('play-icon').className = "fas fa-play";
            document.getElementById('play-text').textContent = "REPRODUCIR";
        }

        window.removeFile = (index) => {
            if (state.currentIndex === index) stopPlayback();
            state.files.splice(index, 1);
            if (state.files.length === 0) {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            }
            renderQueue();
        };

        document.getElementById('clear-queue-btn').onclick = () => {
            stopPlayback();
            state.files = [];
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            zipBtn.classList.add('hidden');
        };

        document.getElementById('close-player').onclick = () => {
            stopPlayback();
            playerModal.classList.add('hidden');
        };

        function formatTime(sec) {
            if (!sec || sec < 0) return "0:00";
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function showStatus(msg, cls) {
            statusArea.textContent = msg;
            statusArea.className = `mb-4 text-center h-5 text-xs font-medium transition-all duration-300 ${cls}`;
        }
        
        document.getElementById('volume-slider').oninput = (e) => {
            if (mm.Player.tone) mm.Player.tone.Destination.volume.rampTo(parseFloat(e.target.value), 0.1);
        };
    </script>
</body>
</html>
